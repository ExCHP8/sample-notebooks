<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>1e26d5ebc8724d06a9da9cace79a1742</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><img
src="https://raw.githubusercontent.com/IBM/watson-machine-learning-samples/master/cloud/notebooks/headers/watsonx-Prompt_Lab-Notebook.png"
alt="image" /></p>
<h1 id="use-watsonx-chroma-and-langchain-to-answer-questions-rag">Use
watsonx, Chroma, and LangChain to answer questions (RAG)</h1>
</div>
<div class="cell markdown" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<h4 id="disclaimers">Disclaimers</h4>
<ul>
<li>Use only Projects and Spaces that are available in watsonx
context.</li>
</ul>
<h2 id="notebook-content">Notebook content</h2>
<p>This notebook contains the steps and code to demonstrate support of
Retrieval Augumented Generation in watsonx.ai. It introduces commands
for data retrieval, knowledge base building &amp; querying, and model
testing.</p>
<p>Some familiarity with Python is helpful. This notebook uses Python
3.10.</p>
<h3 id="about-retrieval-augmented-generation">About Retrieval Augmented
Generation</h3>
<p>Retrieval Augmented Generation (RAG) is a versatile pattern that can
unlock a number of use cases requiring factual recall of information,
such as querying a knowledge base in natural language.</p>
<p>In its simplest form, RAG requires 3 steps:</p>
<ul>
<li>Index knowledge base passages (once)</li>
<li>Retrieve relevant passage(s) from knowledge base (for every user
query)</li>
<li>Generate a response by feeding retrieved passage into a large
language model (for every user query)</li>
</ul>
<h2 id="contents">Contents</h2>
<p>This notebook contains the following parts:</p>
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#data">Document data loading</a></li>
<li><a href="#build_base">Build up knowledge base</a></li>
<li><a href="#models">Foundation Models on watsonx</a></li>
<li><a href="#predict">Generate a retrieval-augmented response to a
question</a></li>
<li><a href="#summary">Summary and next steps</a></li>
</ul>
</div>
<div class="cell markdown" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><a id="setup"></a></p>
<h2 id="set-up-the-environment">Set up the environment</h2>
<p>Before you use the sample code in this notebook, you must perform the
following setup tasks:</p>
<ul>
<li>Create a
<a href="https://console.ng.bluemix.net/catalog/services/ibm-watson-machine-learning/" target="_blank" rel="noopener no referrer">Watson
Machine Learning (WML) Service</a> instance (a free plan is offered and
information about how to create the instance can be found
<a href="https://dataplatform.cloud.ibm.com/docs/content/wsj/analyze-data/ml-service-instance.html?context=analytics" target="_blank" rel="noopener no referrer">here</a>).</li>
</ul>
</div>
<section id="install-and-import-the-dependecies" class="cell markdown"
data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<h3>Install and import the dependecies</h3>
</section>
<div class="cell code" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="st">&quot;langchain==0.0.340&quot;</span> <span class="op">|</span> tail <span class="op">-</span>n <span class="dv">1</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install wget <span class="op">|</span> tail <span class="op">-</span>n <span class="dv">1</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install sentence<span class="op">-</span>transformers <span class="op">|</span> tail <span class="op">-</span>n <span class="dv">1</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="st">&quot;chromadb==0.3.26&quot;</span> <span class="op">|</span> tail <span class="op">-</span>n <span class="dv">1</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="st">&quot;ibm-watson-machine-learning&gt;=1.0.327&quot;</span> <span class="op">|</span> tail <span class="op">-</span>n <span class="dv">1</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="st">&quot;pydantic==1.10.0&quot;</span> <span class="op">|</span> tail <span class="op">-</span>n <span class="dv">1</span></span></code></pre></div>
</div>
<div class="cell code" data-execution_count="2" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, getpass</span></code></pre></div>
</div>
<section id="watsonx-api-connection" class="cell markdown"
data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<h3>watsonx API connection</h3>
<p>This cell defines the credentials required to work with watsonx API
for Foundation Model inferencing.</p>
<p><strong>Action:</strong> Provide the IBM Cloud user API key. For
details, see
<a href="https://cloud.ibm.com/docs/account?topic=account-userapikey&interface=ui" target="_blank" rel="noopener no referrer">documentation</a>.</p>
</section>
<div class="cell code" data-execution_count="3" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>credentials <span class="op">=</span> {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;url&quot;</span>: <span class="st">&quot;https://us-south.ml.cloud.ibm.com&quot;</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;apikey&quot;</span>: getpass.getpass(<span class="st">&quot;Please enter your WML api key (hit enter): &quot;</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<section id="defining-the-project-id" class="cell markdown"
data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<h3>Defining the project id</h3>
<p>The API requires project id that provides the context for the call.
We will obtain the id from the project in which this notebook runs.
Otherwise, please provide the project id.</p>
<p><strong>Hint</strong>: You can find the <code>project_id</code> as
follows. Open the prompt lab in watsonx.ai. At the very top of the UI,
there will be <code>Projects / &lt;project name&gt; /</code>. Click on
the <code>&lt;project name&gt;</code> link. Then get the
<code>project_id</code> from Project's Manage tab (Project -&gt; Manage
-&gt; General -&gt; Details).</p>
</section>
<div class="cell code" data-execution_count="4" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    project_id <span class="op">=</span> os.environ[<span class="st">&quot;PROJECT_ID&quot;</span>]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">KeyError</span>:</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    project_id <span class="op">=</span> <span class="bu">input</span>(<span class="st">&quot;Please enter your project_id (hit enter): &quot;</span>)</span></code></pre></div>
</div>
<div class="cell markdown" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><a id="data"></a></p>
<h2 id="document-data-loading">Document data loading</h2>
<p>Download the file with State of the Union.</p>
</div>
<div class="cell code" data-execution_count="5" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> wget</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;state_of_the_union.txt&#39;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">&#39;https://raw.github.com/IBM/watson-machine-learning-samples/master/cloud/data/foundation_models/state_of_the_union.txt&#39;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.isfile(filename):</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    wget.download(url, out<span class="op">=</span>filename)</span></code></pre></div>
</div>
<div class="cell markdown" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><a id="build_base"></a></p>
<h2 id="build-up-knowledge-base">Build up knowledge base</h2>
<p>The current state-of-the-art in RAG is to create dense vector
representations of the knowledge base in order to calculate the semantic
similarity to a given user query.</p>
</div>
<div class="cell code" data-execution_count="6" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.document_loaders <span class="im">import</span> TextLoader</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.text_splitter <span class="im">import</span> CharacterTextSplitter</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.vectorstores <span class="im">import</span> Chroma</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>loader <span class="op">=</span> TextLoader(filename)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>documents <span class="op">=</span> loader.load()</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>text_splitter <span class="op">=</span> CharacterTextSplitter(chunk_size<span class="op">=</span><span class="dv">1000</span>, chunk_overlap<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>texts <span class="op">=</span> text_splitter.split_documents(documents)</span></code></pre></div>
</div>
<div class="cell markdown" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>The dataset we are using is already split into self-contained
passages that can be ingested by Chroma.</p>
</div>
<section id="create-an-embedding-function" class="cell markdown"
data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<h3>Create an embedding function</h3>
<p>Note that you can feed a custom embedding function to be used by
chromadb. The performance of chromadb may differ depending on the
embedding model used.</p>
</section>
<div class="cell code" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.embeddings <span class="im">import</span> HuggingFaceEmbeddings</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> HuggingFaceEmbeddings()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>docsearch <span class="op">=</span> Chroma.from_documents(texts, embeddings)</span></code></pre></div>
</div>
<div class="cell markdown" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><a id="models"></a></p>
<h2 id="foundation-models-on-watsonxai">Foundation Models on
<code>watsonx.ai</code></h2>
</div>
<section id="defining-model" class="cell markdown"
data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<h3>Defining model</h3>
<p>You need to specify <code>model_id</code> that will be used for
inferencing:</p>
</section>
<div class="cell code" data-execution_count="8" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ibm_watson_machine_learning.foundation_models.utils.enums <span class="im">import</span> ModelTypes</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>model_id <span class="op">=</span> ModelTypes.FLAN_UL2</span></code></pre></div>
</div>
<section id="defining-the-model-parameters" class="cell markdown"
data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<h3>Defining the model parameters</h3>
<p>We need to provide a set of model parameters that will influence the
result:</p>
</section>
<div class="cell code" data-execution_count="9" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ibm_watson_machine_learning.metanames <span class="im">import</span> GenTextParamsMetaNames <span class="im">as</span> GenParams</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ibm_watson_machine_learning.foundation_models.utils.enums <span class="im">import</span> DecodingMethods</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>parameters <span class="op">=</span> {</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    GenParams.DECODING_METHOD: DecodingMethods.GREEDY,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    GenParams.MIN_NEW_TOKENS: <span class="dv">1</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    GenParams.MAX_NEW_TOKENS: <span class="dv">100</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div class="cell markdown" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Initialize the <code>Model</code> class.</p>
</div>
<div class="cell code" data-execution_count="10" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ibm_watson_machine_learning.foundation_models <span class="im">import</span> Model</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    model_id<span class="op">=</span>model_id,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    params<span class="op">=</span>parameters,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    credentials<span class="op">=</span>credentials,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    project_id<span class="op">=</span>project_id</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="cell markdown" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><a id="predict"></a></p>
<h2 id="generate-a-retrieval-augmented-response-to-a-question">Generate
a retrieval-augmented response to a question</h2>
</div>
<div class="cell markdown">
<p><code>RetrievalQA</code> is a chain to do question answering.</p>
<p><strong>Hint:</strong> To use Chain interface from LangChain with
watsonx.ai models you must call <code>model.to_langchain()</code>
method.</p>
<p>It returns <code>WatsonxLLM</code> wrapper compatible with LangChain
CustomLLM specification.</p>
</div>
<section id="select-questions" class="cell markdown"
data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<h3>Select questions</h3>
<p>Get questions from the previously loaded test dataset.</p>
</section>
<div class="cell code" data-execution_count="11" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.chains <span class="im">import</span> RetrievalQA</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>qa <span class="op">=</span> RetrievalQA.from_chain_type(llm<span class="op">=</span>model.to_langchain(), chain_type<span class="op">=</span><span class="st">&quot;stuff&quot;</span>, retriever<span class="op">=</span>docsearch.as_retriever())</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">&quot;What did the president say about Ketanji Brown Jackson&quot;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>qa.run(query)</span></code></pre></div>
<div class="output execute_result" data-execution_count="11">
<pre><code>&#39;One of our nation’s top legal minds, who will continue Justice Breyer’s legacy of excellence&#39;</code></pre>
</div>
</div>
<div class="cell markdown" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<hr />
</div>
<div class="cell markdown" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><a id="summary"></a></p>
<h2 id="summary-and-next-steps">Summary and next steps</h2>
<p>You successfully completed this notebook!.</p>
<p>You learned how to answer question using RAG using watsonx and
LangChain.</p>
<p>Check out our
<em><a href="https://ibm.github.io/watson-machine-learning-sdk/samples.html" target="_blank" rel="noopener no referrer">Online
Documentation</a></em> for more samples, tutorials, documentation,
how-tos, and blog posts.</p>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Copyright © 2023 IBM. This notebook and its source code are released
under the terms of the MIT License.</p>
</div>
</body>
</html>
