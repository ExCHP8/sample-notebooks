<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>99aeb14c136844e086fc66f0aaa6335d</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><img
src="https://raw.githubusercontent.com/IBM/watson-machine-learning-samples/master/cloud/notebooks/headers/watsonx-Prompt_Lab-Notebook.png"
alt="image" /></p>
<h1
id="use-watsonx-to-tune-google-flan-t5-xl-model-with-consumer-financial-protection-bureau-document">Use
watsonx to tune Google 'flan-t5-xl' model with Consumer Financial
Protection Bureau document</h1>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<h4 id="disclaimers">Disclaimers</h4>
<ul>
<li>Use only Projects and Spaces that are available in watsonx
context.</li>
</ul>
<h2 id="notebook-content">Notebook content</h2>
<p>This notebook contains the steps and code to demonstrate support of
prompt tuning in watsonx.</p>
<p>Some familiarity with Python is helpful. This notebook uses Python
3.10.</p>
<h2 id="learning-goal">Learning goal</h2>
<p>The goal of this notebook is to demonstrate how to:</p>
<ul>
<li>upload of dataset with prompts to container (project)</li>
<li>trigger prompt tuning process</li>
<li>review of prompt tuning process details/results</li>
<li>deploy prompt-tuned model/asset</li>
<li>inference of prompt-tuned model/asset</li>
</ul>
<h2 id="contents">Contents</h2>
<p>This notebook contains the following parts:</p>
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#data_loading">Data loading</a></li>
<li><a href="#initialize">Initialize experiment</a></li>
<li><a href="#run_tuning">Run Prompt Tuning</a></li>
<li><a href="#run_details">Prompt Tuning details</a></li>
<li><a href="#deploy">Deploy</a></li>
<li><a href="#models_inference">Foundation Models Inference on
<code>watsonx.ai</code></a></li>
<li><a href="#predict">Analyze the satisfaction</a></li>
<li><a href="#summary">Summary and next steps</a></li>
</ul>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><a id="setup"></a></p>
<h2 id="set-up-the-environment">Set up the environment</h2>
<p>Before you use the sample code in this notebook, you must perform the
following setup tasks:</p>
<ul>
<li>Create a
<a href="https://console.ng.bluemix.net/catalog/services/ibm-watson-machine-learning/" target="_blank" rel="noopener no referrer">Watson
Machine Learning (WML) Service</a> instance (a free plan is offered and
information about how to create the instance can be found
<a href="https://dataplatform.cloud.ibm.com/docs/content/wsj/analyze-data/ml-service-instance.html?context=analytics" target="_blank" rel="noopener no referrer">here</a>).</li>
</ul>
</div>
<section id="install-and-import-the-datasets-and-dependecies"
class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<h3>Install and import the <code>datasets</code> and dependecies</h3>
</section>
<div class="cell code"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install ibm<span class="op">-</span>watson<span class="op">-</span>machine<span class="op">-</span>learning<span class="op">==</span><span class="fl">1.0.335</span> <span class="op">|</span> tail <span class="op">-</span>n <span class="dv">1</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install scikit<span class="op">-</span>learn <span class="op">|</span> tail <span class="op">-</span>n <span class="dv">1</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install matplotlib <span class="op">|</span> tail <span class="op">-</span>n <span class="dv">1</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install wget <span class="op">|</span> tail <span class="op">-</span>n <span class="dv">1</span></span></code></pre></div>
</div>
<section id="watsonx-api-connection" class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<h3>Watsonx API connection</h3>
<p>This cell defines the credentials required to work with watsonx API
for Foundation Model inferencing.</p>
<p><strong>Action:</strong> Provide the IBM Cloud user API key. For
details, see
<a href="https://cloud.ibm.com/docs/account?topic=account-userapikey&interface=ui" target="_blank" rel="noopener no referrer">documentation</a>.</p>
</section>
<div class="cell code" data-execution_count="2"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> getpass</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>credentials <span class="op">=</span> {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;url&quot;</span>: <span class="st">&quot;https://us-south.ml.cloud.ibm.com&quot;</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;apikey&quot;</span>: getpass.getpass(<span class="st">&quot;Please enter your WML api key (hit enter): &quot;</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<section id="defining-the-project-id" class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<h3>Defining the project id</h3>
<p>The Foundation Model requires project id that provides the context
for the call. We will obtain the id from the project in which this
notebook runs. Otherwise, please provide the project id.</p>
</section>
<div class="cell code" data-execution_count="3"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    project_id <span class="op">=</span> os.environ[<span class="st">&quot;PROJECT_ID&quot;</span>]</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">KeyError</span>:</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    project_id <span class="op">=</span> <span class="bu">input</span>(<span class="st">&quot;Please enter your project_id (hit enter): &quot;</span>)</span></code></pre></div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Create an instance of APIClient with authentication details.</p>
</div>
<div class="cell code" data-execution_count="4"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ibm_watson_machine_learning <span class="im">import</span> APIClient</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> APIClient(credentials)</span></code></pre></div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>To be able to interact with all resources available in Watson Machine
Learning, you need to set <strong>project_id</strong> which you will be
using.</p>
</div>
<div class="cell code" data-execution_count="5"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>client.<span class="bu">set</span>.default_project(project_id)</span></code></pre></div>
<div class="output execute_result" data-execution_count="5">
<pre><code>&#39;SUCCESS&#39;</code></pre>
</div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><a id="data_loading"></a></p>
<h2 id="data-loading">Data loading</h2>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>This example uses the Consumer Financial Protection Bureau training
dataset.</p>
</div>
<div class="cell code" data-execution_count="6">
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;cfpb_train.json&#39;</span></span></code></pre></div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Download training data from git repository and create data
assets.</p>
</div>
<div class="cell code" data-execution_count="7"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> wget</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">&quot;https://raw.github.com/IBM/watson-machine-learning-samples/master/cloud/data/prompt_tuning/cfpb_train.json&quot;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.isfile(filename): </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    wget.download(url)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>asset_details <span class="op">=</span> client.data_assets.create(name<span class="op">=</span>filename, file_path<span class="op">=</span>filename)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Creating data asset...
SUCCESS
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="8"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>asset_id <span class="op">=</span> client.data_assets.get_id(asset_details)</span></code></pre></div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Define connection information to training data.</p>
</div>
<div class="cell code" data-execution_count="9"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ibm_watson_machine_learning.helpers <span class="im">import</span> DataConnection</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>data_conn <span class="op">=</span> DataConnection(data_asset_id<span class="op">=</span>asset_id)</span></code></pre></div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><a id="initialize"></a></p>
<h2 id="initialize-experiment">Initialize experiment</h2>
</div>
<div class="cell code" data-execution_count="10"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ibm_watson_machine_learning.experiment <span class="im">import</span> TuneExperiment</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>experiment <span class="op">=</span> TuneExperiment(credentials, project_id<span class="op">=</span>project_id)</span></code></pre></div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>All avaliable tasks are presented under <code>Tasks</code> Enum</p>
</div>
<div class="cell code" data-execution_count="11"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>{task.name: task.value <span class="cf">for</span> task <span class="kw">in</span> experiment.Tasks}</span></code></pre></div>
<div class="output execute_result" data-execution_count="11">
<pre><code>{&#39;QUESTION_ANSWERING&#39;: &#39;question_answering&#39;,
 &#39;SUMMARIZATION&#39;: &#39;summarization&#39;,
 &#39;RETRIEVAL_AUGMENTED_GENERATION&#39;: &#39;retrieval_augmented_generation&#39;,
 &#39;CLASSIFICATION&#39;: &#39;classification&#39;,
 &#39;GENERATION&#39;: &#39;generation&#39;,
 &#39;CODE_GENERATION_AND_CONVERSION&#39;: &#39;code&#39;,
 &#39;EXTRACTION&#39;: &#39;extraction&#39;}</code></pre>
</div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Define <code>prompt_tuner</code> parameters</p>
</div>
<div class="cell code" data-execution_count="12"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>prompt_tuner <span class="op">=</span> experiment.prompt_tuner(name<span class="op">=</span><span class="st">&quot;sample SDK run auto_update True&quot;</span>,</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                                       task_id<span class="op">=</span>experiment.Tasks.CLASSIFICATION,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                                       base_model<span class="op">=</span><span class="st">&#39;google/flan-t5-xl&#39;</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                                       accumulate_steps<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                                       batch_size<span class="op">=</span><span class="dv">16</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                                       learning_rate<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>                                       max_input_tokens<span class="op">=</span><span class="dv">256</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>                                       max_output_tokens<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>                                       num_epochs<span class="op">=</span><span class="dv">6</span>,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>                                       tuning_type<span class="op">=</span>experiment.PromptTuningTypes.PT,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>                                       verbalizer<span class="op">=</span><span class="st">&quot;Including narratives choice the best match product with the items from the list: &#39;credit_card&#39;, &#39;debt_collection&#39;, &#39;mortgages_and_loans&#39;, &#39;credit_reporting&#39;, &#39;retail_banking&#39;. Input: </span><span class="sc">{{</span><span class="st">input</span><span class="sc">}}</span><span class="st"> Output: &quot;</span>,</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>                                       auto_update_model<span class="op">=</span><span class="va">True</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>                                       )</span></code></pre></div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>You can review previous set parameters</p>
</div>
<div class="cell code" data-execution_count="13"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>prompt_tuner.get_params()</span></code></pre></div>
<div class="output execute_result" data-execution_count="13">
<pre><code>{&#39;base_model&#39;: {&#39;model_id&#39;: &#39;google/flan-t5-xl&#39;},
 &#39;accumulate_steps&#39;: 32,
 &#39;batch_size&#39;: 16,
 &#39;learning_rate&#39;: 0.2,
 &#39;max_input_tokens&#39;: 256,
 &#39;max_output_tokens&#39;: 20,
 &#39;num_epochs&#39;: 6,
 &#39;task_id&#39;: &#39;classification&#39;,
 &#39;tuning_type&#39;: &#39;prompt_tuning&#39;,
 &#39;verbalizer&#39;: &quot;Including narratives choice the best match product with the items from the list: &#39;credit_card&#39;, &#39;debt_collection&#39;, &#39;mortgages_and_loans&#39;, &#39;credit_reporting&#39;, &#39;retail_banking&#39;. Input: {{input}} Output: &quot;,
 &#39;name&#39;: &#39;sample SDK run auto_update True&#39;,
 &#39;description&#39;: &#39;Prompt tuning with SDK&#39;,
 &#39;auto_update_model&#39;: True,
 &#39;group_by_name&#39;: False}</code></pre>
</div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><a id="run_tuning"></a></p>
<h2 id="run-prompt-tuning">Run Prompt Tuning</h2>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Run a prompt tuning process of foundation model on top of the
training data referenced by DataConnection (tuning may take some
time).</p>
<p>By changing the <code>background_mode</code> parameter to
<code>True</code>, the prompt tuning process will run in the
background.</p>
</div>
<div class="cell code" data-execution_count="14"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>tuning_details <span class="op">=</span> prompt_tuner.run(training_data_references<span class="op">=</span>[data_conn], background_mode<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>

##############################################

Running &#39;b4300476-f8dd-4684-81ec-290c15d1ed95&#39;

##############################################


pending........
running.....................................................................................
completed
Training of &#39;b4300476-f8dd-4684-81ec-290c15d1ed95&#39; finished successfully.
</code></pre>
</div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><a id="run_details"></a></p>
<h2 id="prompt-tuning-details">Prompt Tuning details</h2>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Check status/state of initialized Prompt Tuning run if ran in
background mode or when process finish if background mode is off.</p>
</div>
<div class="cell code" data-execution_count="15"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>prompt_tuner.get_run_status()</span></code></pre></div>
<div class="output execute_result" data-execution_count="15">
<pre><code>&#39;completed&#39;</code></pre>
</div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Get prompt tuning run details.</p>
</div>
<div class="cell code" data-execution_count="16"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>prompt_tuner.get_run_details()</span></code></pre></div>
<div class="output execute_result" data-execution_count="16">
<pre><code>{&#39;metadata&#39;: {&#39;created_at&#39;: &#39;2023-12-06T14:31:27.126Z&#39;,
  &#39;description&#39;: &#39;Prompt tuning with SDK&#39;,
  &#39;id&#39;: &#39;b4300476-f8dd-4684-81ec-290c15d1ed95&#39;,
  &#39;modified_at&#39;: &#39;2023-12-06T14:41:17.834Z&#39;,
  &#39;name&#39;: &#39;sample SDK run auto_update True&#39;,
  &#39;project_id&#39;: &#39;70b1b2eb-b820-41ee-bcfb-76d8d83ee5c0&#39;,
  &#39;tags&#39;: [&#39;prompt_tuning&#39;,
   &#39;wx_prompt_tune.2e31c747-cb30-49ce-9cff-ccad973ad9d2&#39;]},
 &#39;entity&#39;: {&#39;auto_update_model&#39;: True,
  &#39;description&#39;: &#39;Prompt tuning with SDK&#39;,
  &#39;model_id&#39;: &#39;a0613c34-faa5-49c0-86b5-9d3357293ce1&#39;,
  &#39;name&#39;: &#39;sample SDK run auto_update True&#39;,
  &#39;project_id&#39;: &#39;70b1b2eb-b820-41ee-bcfb-76d8d83ee5c0&#39;,
  &#39;prompt_tuning&#39;: {&#39;accumulate_steps&#39;: 32,
   &#39;base_model&#39;: {&#39;model_id&#39;: &#39;google/flan-t5-xl&#39;},
   &#39;batch_size&#39;: 16,
   &#39;init_method&#39;: &#39;random&#39;,
   &#39;learning_rate&#39;: 0.2,
   &#39;max_input_tokens&#39;: 256,
   &#39;max_output_tokens&#39;: 20,
   &#39;num_epochs&#39;: 6,
   &#39;num_virtual_tokens&#39;: 100,
   &#39;task_id&#39;: &#39;classification&#39;,
   &#39;tuning_type&#39;: &#39;prompt_tuning&#39;,
   &#39;verbalizer&#39;: &quot;Including narratives choice the best match product with the items from the list: &#39;credit_card&#39;, &#39;debt_collection&#39;, &#39;mortgages_and_loans&#39;, &#39;credit_reporting&#39;, &#39;retail_banking&#39;. Input: {{input}} Output: &quot;},
  &#39;results_reference&#39;: {&#39;connection&#39;: {},
   &#39;location&#39;: {&#39;path&#39;: &#39;default_tuning_output&#39;,
    &#39;training&#39;: &#39;default_tuning_output/b4300476-f8dd-4684-81ec-290c15d1ed95&#39;,
    &#39;training_status&#39;: &#39;default_tuning_output/b4300476-f8dd-4684-81ec-290c15d1ed95/training-status.json&#39;,
    &#39;model_request_path&#39;: &#39;default_tuning_output/b4300476-f8dd-4684-81ec-290c15d1ed95/assets/b4300476-f8dd-4684-81ec-290c15d1ed95/resources/wml_model/request.json&#39;,
    &#39;assets_path&#39;: &#39;default_tuning_output/b4300476-f8dd-4684-81ec-290c15d1ed95/assets&#39;},
   &#39;type&#39;: &#39;container&#39;},
  &#39;status&#39;: {&#39;completed_at&#39;: &#39;2023-12-06T14:41:17.672Z&#39;, &#39;state&#39;: &#39;completed&#39;},
  &#39;tags&#39;: [&#39;prompt_tuning&#39;,
   &#39;wx_prompt_tune.2e31c747-cb30-49ce-9cff-ccad973ad9d2&#39;],
  &#39;training_data_references&#39;: [{&#39;connection&#39;: {},
    &#39;location&#39;: {&#39;href&#39;: &#39;/v2/assets/606d9ab5-4672-4807-83f0-33615279392d&#39;,
     &#39;id&#39;: &#39;606d9ab5-4672-4807-83f0-33615279392d&#39;},
    &#39;type&#39;: &#39;data_asset&#39;}]}}</code></pre>
</div>
</div>
<div class="cell markdown">
<p>Let's summarize the run.</p>
</div>
<div class="cell code" data-execution_count="17">
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>prompt_tuner.summary()</span></code></pre></div>
<div class="output execute_result" data-execution_count="17">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Enhancements</th>
      <th>Base model</th>
      <th>Auto store</th>
      <th>Epochs</th>
      <th>loss</th>
    </tr>
    <tr>
      <th>Model Name</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>model_b4300476-f8dd-4684-81ec-290c15d1ed95</th>
      <td>[prompt_tuning]</td>
      <td>google/flan-t5-xl</td>
      <td>True</td>
      <td>6</td>
      <td>0.356224</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell markdown" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Plot learning curves.</p>
</div>
<div class="cell code" data-execution_count="19" data-collapsed="false"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>prompt_tuner.plot_learning_curve()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_49e10da78c1a4bd99d55758f75f94fac/b06dd934d1e2ff1718803b8bc309d4c66522d71a.png" /></p>
</div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><a id="deploy"></a></p>
<h2 id="deploy">Deploy</h2>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>You can specify <code>model_id</code> from tuning details.</p>
</div>
<div class="cell code" data-execution_count="20"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>model_id <span class="op">=</span> <span class="va">None</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;model_id&#39;</span> <span class="kw">in</span> tuning_details.get(<span class="st">&#39;entity&#39;</span>, {}):</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    model_id <span class="op">=</span> tuning_details[<span class="st">&#39;entity&#39;</span>][<span class="st">&#39;model_id&#39;</span>]</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>model_id</span></code></pre></div>
<div class="output execute_result" data-execution_count="20">
<pre><code>&#39;a0613c34-faa5-49c0-86b5-9d3357293ce1&#39;</code></pre>
</div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Create online deployment for published model.</p>
</div>
<div class="cell code" data-execution_count="21"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>meta_props <span class="op">=</span> {</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    client.deployments.ConfigurationMetaNames.NAME: <span class="st">&quot;PT DEPLOYMENT SDK - project&quot;</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    client.deployments.ConfigurationMetaNames.ONLINE: {},</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    client.deployments.ConfigurationMetaNames.SERVING_NAME : <span class="ss">f&quot;pt_sdk_deployment_</span><span class="sc">{</span>datetime<span class="sc">.</span>utcnow()<span class="sc">.</span>strftime(<span class="st">&#39;%Y_%m_</span><span class="sc">%d</span><span class="st">_%H%M%S&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>deployment_details <span class="op">=</span> client.deployments.create(model_id, meta_props)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>

#######################################################################################

Synchronous deployment creation for uid: &#39;a0613c34-faa5-49c0-86b5-9d3357293ce1&#39; started

#######################################################################################


initializing
ready


------------------------------------------------------------------------------------------------
Successfully finished deployment creation, deployment_uid=&#39;5217e49f-3c61-4f06-ac67-ca1b2de4bdf2&#39;
------------------------------------------------------------------------------------------------


</code></pre>
</div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Additionally you can get deployment details by printing
<code>deployment_details</code></p>
</div>
<div class="cell code">
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>deployment_details</span></code></pre></div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>You can specify <code>deployment_id</code> from deployment
details.</p>
</div>
<div class="cell code" data-execution_count="23"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>deployment_id <span class="op">=</span> deployment_details[<span class="st">&#39;metadata&#39;</span>][<span class="st">&#39;id&#39;</span>]</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>deployment_id</span></code></pre></div>
<div class="output execute_result" data-execution_count="23">
<pre><code>&#39;5217e49f-3c61-4f06-ac67-ca1b2de4bdf2&#39;</code></pre>
</div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><a id="models_inference"></a></p>
<h2 id="foundation-models-inference-on-watsonxai">Foundation Models
Inference on <code>watsonx.ai</code></h2>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Provide a set of model parameters.</p>
</div>
<div class="cell code" data-execution_count="24"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ibm_watson_machine_learning.metanames <span class="im">import</span> GenTextParamsMetaNames <span class="im">as</span> GenParams</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>generate_params <span class="op">=</span> {</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    GenParams.MAX_NEW_TOKENS: <span class="dv">20</span>,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    GenParams.STOP_SEQUENCES: [<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>]</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Initialize the <code>ModelInference</code> class.</p>
</div>
<div class="cell code" data-execution_count="25"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ibm_watson_machine_learning.foundation_models <span class="im">import</span> ModelInference</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>tuned_model <span class="op">=</span> ModelInference(</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    deployment_id<span class="op">=</span>deployment_id,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    params<span class="op">=</span>generate_params,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    api_client<span class="op">=</span>client</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Alternatively you can use <code>credentials</code> and
<code>project_id</code> to initialize the <code>ModelInference</code>
class.</p>
<pre><code>tuned_model = ModelInference(
    deployment_id=deployment_id,
    params=generate_params,
    credentials=credentials,
    project_id=project_id
)
</code></pre>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Get deployment model inference details.</p>
</div>
<div class="cell code"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb36"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>tuned_model.get_details()</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Analyze the product class for a sample prompt.</p>
</div>
<div class="cell code" data-execution_count="27"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> tuned_model.generate_text(prompt<span class="op">=</span><span class="st">&quot;Including narratives choice the best match product with the items from the list: &#39;credit_card&#39;, &#39;debt_collection&#39;, &#39;mortgages_and_loans&#39;, &#39;credit_reporting&#39;, &#39;retail_banking&#39;.</span><span class="ch">\n</span><span class="st">Comment: hi landed job reside ca needed room rent found place rent paid deposit dollar however position going didnt work longer needed rent place bay asked landlord refund security deposit refused told called back wellsfargo disputed transaction recently noticed card reversal checking account got charged amount dollar called bank werent able refund money also emailed landlord asking refund money ten day passed still response hope cfpb take action successfully resolve issue thank</span><span class="ch">\n</span><span class="st">Product:</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>response</span></code></pre></div>
<div class="output execute_result" data-execution_count="27">
<pre><code>&#39;credit_card&#39;</code></pre>
</div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><a id="predict"></a></p>
<h2 id="analyze-the-product-classes">Analyze the product classes.</h2>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Download and prepare the <code>cfpb_test</code> dataset.</p>
</div>
<div class="cell code" data-execution_count="28"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;cfpb_test.json&#39;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">&quot;https://raw.github.com/IBM/watson-machine-learning-samples/master/cloud/data/prompt_tuning/cfpb_test.json&quot;</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.isfile(filename): </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    wget.download(url)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_json(filename)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="29"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb40"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>prompts <span class="op">=</span> <span class="bu">list</span>(data.<span class="bu">input</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>products <span class="op">=</span> <span class="bu">list</span>(data.output)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="30"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>prompts_batch <span class="op">=</span> [<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>.join([prompt]) <span class="cf">for</span> prompt <span class="kw">in</span> prompts]</span></code></pre></div>
</div>
<section id="calculate-the-accuracy-of-tuned-model"
class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<h3>Calculate the accuracy of tuned model</h3>
</section>
<div class="cell code" data-execution_count="31"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb42"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>tuned_model_results <span class="op">=</span> tuned_model.generate_text(prompt<span class="op">=</span>prompts_batch)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="32"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb43"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;accuracy_score: </span><span class="sc">{</span>accuracy_score(products, tuned_model_results)<span class="sc">}</span><span class="ss">&#39;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>accuracy_score: 0.6266666666666667
</code></pre>
</div>
</div>
<section id="calculate-the-accuracy-of-base-model" class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<h3>Calculate the accuracy of base model</h3>
</section>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Initialize the <code>ModelInference</code> class with base model.</p>
</div>
<div class="cell code" data-execution_count="33"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb45"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>base_model <span class="op">=</span> ModelInference(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    model_id<span class="op">=</span><span class="st">&#39;google/flan-t5-xl&#39;</span>,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    params<span class="op">=</span>generate_params,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    api_client<span class="op">=</span>client</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="34"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb46"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>base_model_results <span class="op">=</span> base_model.generate_text(prompt<span class="op">=</span>prompts_batch)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="35"
data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}">
<div class="sourceCode" id="cb47"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;base model accuracy_score: </span><span class="sc">{</span>accuracy_score(products, base_model_results)<span class="sc">}</span><span class="ss">&#39;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>base model accuracy_score: 0.5333333333333333
</code></pre>
</div>
</div>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p><a id="summary"></a></p>
<h2 id="summary-and-next-steps">Summary and next steps</h2>
<p>You successfully completed this notebook!.</p>
<p>You learned how to use prompt tuning in watsonx for analyze the
product classes for a sample prompts.</p>
<p>Check out our
<em><a href="https://ibm.github.io/watson-machine-learning-sdk/samples.html" target="_blank" rel="noopener no referrer">Online
Documentation</a></em> for more samples, tutorials, documentation,
how-tos, and blog posts.</p>
</div>
<section id="authors" class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<h3>Authors:</h3>
<p><strong>Mateusz Szewczyk</strong>, Software Engineer at Watson
Machine Learning.</p>
</section>
<div class="cell markdown"
data-pycharm="{&quot;name&quot;:&quot;#%% md\n&quot;}">
<p>Copyright © 2023 IBM. This notebook and its source code are released
under the terms of the MIT License.</p>
</div>
</body>
</html>
